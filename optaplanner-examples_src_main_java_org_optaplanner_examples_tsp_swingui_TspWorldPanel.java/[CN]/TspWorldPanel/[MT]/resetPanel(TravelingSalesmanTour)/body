{
  translator=new LatitudeLongitudeTranslator();
  for (  Location location : travelingSalesmanTour.getLocationList()) {
    translator.addCoordinates(location.getLatitude(),location.getLongitude());
  }
  Dimension size=getSize();
  double width=size.getWidth();
  double height=size.getHeight();
  translator.prepareFor(width,height);
  Graphics2D g=createCanvas(width,height);
  String tourName=travelingSalesmanTour.getName();
  if (tourName.startsWith("europe")) {
    g.drawImage(europaBackground.getImage(),0,0,translator.getImageWidth(),translator.getImageHeight(),this);
  }
  g.setFont(g.getFont().deriveFont((float)LOCATION_NAME_TEXT_SIZE));
  g.setColor(TangoColorFactory.PLUM_2);
  List<Visit> visitList=travelingSalesmanTour.getVisitList();
  for (  Visit visit : visitList) {
    Location location=visit.getLocation();
    int x=translator.translateLongitudeToX(location.getLongitude());
    int y=translator.translateLatitudeToY(location.getLatitude());
    g.fillRect(x - 1,y - 1,3,3);
    if (location.getName() != null && visitList.size() <= 500) {
      g.drawString(StringUtils.abbreviate(location.getName(),20),x + 3,y - 3);
    }
  }
  g.setColor(TangoColorFactory.ALUMINIUM_4);
  Domicile domicile=travelingSalesmanTour.getDomicile();
  Location domicileLocation=domicile.getLocation();
  int domicileX=translator.translateLongitudeToX(domicileLocation.getLongitude());
  int domicileY=translator.translateLatitudeToY(domicileLocation.getLatitude());
  g.fillRect(domicileX - 2,domicileY - 2,5,5);
  if (domicileLocation.getName() != null && visitList.size() <= 500) {
    g.drawString(domicileLocation.getName(),domicileX + 3,domicileY - 3);
  }
  Set<Visit> needsBackToDomicileLineSet=new HashSet<Visit>(visitList);
  for (  Visit trailingVisit : visitList) {
    if (trailingVisit.getPreviousStandstill() instanceof Visit) {
      needsBackToDomicileLineSet.remove(trailingVisit.getPreviousStandstill());
    }
  }
  g.setColor(TangoColorFactory.CHOCOLATE_1);
  for (  Visit visit : visitList) {
    if (visit.getPreviousStandstill() != null) {
      Location previousLocation=visit.getPreviousStandstill().getLocation();
      Location location=visit.getLocation();
      translator.drawRoute(g,previousLocation.getLongitude(),previousLocation.getLatitude(),location.getLongitude(),location.getLatitude(),location instanceof AirLocation,false);
      if (needsBackToDomicileLineSet.contains(visit)) {
        translator.drawRoute(g,location.getLongitude(),location.getLatitude(),domicileLocation.getLongitude(),domicileLocation.getLatitude(),location instanceof AirLocation,true);
      }
    }
  }
  g.setColor(TangoColorFactory.ALUMINIUM_4);
  g.fillRect(5,(int)height - 15 - TEXT_SIZE,5,5);
  g.drawString("Domicile",15,(int)height - 10 - TEXT_SIZE);
  g.setColor(TangoColorFactory.PLUM_2);
  g.fillRect(6,(int)height - 9,3,3);
  g.drawString("Visit",15,(int)height - 5);
  g.setColor(TangoColorFactory.ALUMINIUM_5);
  String locationsSizeString=travelingSalesmanTour.getLocationList().size() + " locations";
  g.drawString(locationsSizeString,((int)width - g.getFontMetrics().stringWidth(locationsSizeString)) / 2,(int)height - 5);
  if (travelingSalesmanTour.getDistanceType() == DistanceType.AIR_DISTANCE) {
    String clickString="Left click anywhere in the map to add a visit.";
    g.drawString(clickString,(int)width - 5 - g.getFontMetrics().stringWidth(clickString),(int)height - 10 - TEXT_SIZE);
  }
  if (travelingSalesmanTour.getDistanceType() == DistanceType.AIR_DISTANCE) {
    String clickString="Right click near a visit to append it to the end.";
    g.drawString(clickString,(int)width - 5 - g.getFontMetrics().stringWidth(clickString),(int)height - 5);
  }
  g.setColor(TangoColorFactory.ORANGE_3);
  SimpleLongScore score=travelingSalesmanTour.getScore();
  if (score != null) {
    String distanceString=travelingSalesmanTour.getDistanceString(NUMBER_FORMAT);
    g.setFont(g.getFont().deriveFont(Font.BOLD,(float)TEXT_SIZE * 2));
    g.drawString(distanceString,(int)width - g.getFontMetrics().stringWidth(distanceString) - 10,(int)height - 15 - 2 * TEXT_SIZE);
  }
  repaint();
}
