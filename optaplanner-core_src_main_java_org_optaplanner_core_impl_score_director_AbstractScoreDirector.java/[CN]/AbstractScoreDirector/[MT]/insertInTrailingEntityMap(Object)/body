{
  if (hasChainedVariables) {
    for (    Map.Entry<PlanningVariableDescriptor,Map<Object,Set<Object>>> entry : chainedVariableToTrailingEntitiesMap.entrySet()) {
      PlanningVariableDescriptor variableDescriptor=entry.getKey();
      if (variableDescriptor.getEntityDescriptor().matchesEntity(entity)) {
        Object value=variableDescriptor.getValue(entity);
        Map<Object,Set<Object>> valueToTrailingEntityMap=entry.getValue();
        Set<Object> trailingEntities=valueToTrailingEntityMap.get(value);
        if (trailingEntities == null) {
          trailingEntities=Collections.newSetFromMap(new IdentityHashMap<Object,Boolean>());
          valueToTrailingEntityMap.put(value,trailingEntities);
        }
        boolean addSucceeded=trailingEntities.add(entity);
        if (!addSucceeded) {
          throw new IllegalStateException("The ScoreDirector (" + getClass() + ") is corrupted,"+ " because the entity ("+ entity+ ") for chained planningVariable ("+ variableDescriptor.getVariableName()+ ") cannot be inserted: it was already inserted.");
        }
      }
    }
  }
}
