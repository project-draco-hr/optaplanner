{
  if (hasChainedVariables) {
    for (    Map.Entry<PlanningVariableDescriptor,Map<Object,Set<Object>>> entry : chainedVariableToTrailingEntitiesMap.entrySet()) {
      PlanningVariableDescriptor variableDescriptor=entry.getKey();
      if (variableDescriptor.getEntityDescriptor().appliesToPlanningEntity(entity)) {
        Object value=variableDescriptor.getValue(entity);
        Map<Object,Set<Object>> valueToTrailingEntityMap=entry.getValue();
        Set<Object> trailingEntities=valueToTrailingEntityMap.get(value);
        boolean removeSucceeded=trailingEntities != null && trailingEntities.remove(entity);
        if (!removeSucceeded) {
          throw new IllegalStateException("The ScoreDirector (" + getClass() + ") is corrupted,"+ " because the entity ("+ entity+ ") for chained planningVariable ("+ variableDescriptor.getVariableName()+ ") cannot be retracted: it was never inserted.");
        }
        if (trailingEntities.isEmpty()) {
          valueToTrailingEntityMap.put(value,null);
        }
      }
    }
  }
}
