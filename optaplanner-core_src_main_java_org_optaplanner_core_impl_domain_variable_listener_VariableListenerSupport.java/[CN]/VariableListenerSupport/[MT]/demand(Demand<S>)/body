{
  S supply=(S)supplyMap.get(demand);
  if (supply == null) {
    supply=demand.createExternalizedSupply(scoreDirector);
    if (supply instanceof StatefulVariableListener) {
      StatefulVariableListener variableListener=(StatefulVariableListener)supply;
      variableListener.resetWorkingSolution(scoreDirector);
      VariableDescriptor source=variableListener.getSourceVariableDescriptor();
      VariableListenerNotifiable notifiable=new VariableListenerNotifiable(variableListener,nextGlobalOrder);
      nextGlobalOrder++;
      List<VariableListenerNotifiable> variableNotifiableList=sourceVariableToNotifiableMap.get(source);
      variableNotifiableList.add(notifiable);
      List<VariableListenerNotifiable> entityNotifiableList=sourceEntityToNotifiableMap.get(source.getEntityDescriptor());
      if (!entityNotifiableList.contains(notifiable)) {
        entityNotifiableList.add(notifiable);
      }
      Set<VariableListenerNotification> notificationQueue=new LinkedHashSet<VariableListenerNotification>();
      notificationQueueMap.put(notifiable,notificationQueue);
    }
    supplyMap.put(demand,supply);
  }
  return supply;
}
