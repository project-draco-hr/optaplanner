{
  S supply=(S)supplyMap.get(demand);
  if (supply == null) {
    supply=demand.createExternalizedSupply(scoreDirector);
    if (supply instanceof StatefulVariableListener) {
      StatefulVariableListener statefulVariableListener=(StatefulVariableListener)supply;
      statefulVariableListener.resetWorkingSolution(scoreDirector);
      VariableDescriptor sourceVariableDescriptor=statefulVariableListener.getSourceVariableDescriptor();
      List<VariableListener> variableListenerList=variableListenerMap.get(sourceVariableDescriptor);
      if (variableListenerList == null) {
        variableListenerList=new ArrayList<VariableListener>();
        variableListenerMap.put(sourceVariableDescriptor,variableListenerList);
      }
      variableListenerList.add(statefulVariableListener);
      EntityDescriptor entityDescriptor=sourceVariableDescriptor.getEntityDescriptor();
      List<VariableListener> entityVariableListenerList=entityVariableListenerMap.get(entityDescriptor);
      if (entityVariableListenerList == null) {
        entityVariableListenerList=new ArrayList<VariableListener>();
        entityVariableListenerMap.put(entityDescriptor,entityVariableListenerList);
      }
      entityVariableListenerList.add(statefulVariableListener);
    }
    supplyMap.put(demand,supply);
  }
  return supply;
}
