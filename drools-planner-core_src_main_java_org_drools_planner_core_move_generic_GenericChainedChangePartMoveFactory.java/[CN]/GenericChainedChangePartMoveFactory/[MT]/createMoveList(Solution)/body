{
  List<Move> moveList=new ArrayList<Move>();
  Solution workingSolution=scoreDirector.getWorkingSolution();
  for (  PlanningEntityDescriptor entityDescriptor : solutionDescriptor.getPlanningEntityDescriptors()) {
    for (    PlanningVariableDescriptor variableDescriptor : entityDescriptor.getPlanningVariableDescriptors()) {
      if (variableDescriptor.isChained()) {
        Collection<?> values=variableDescriptor.extractAllPlanningValues(workingSolution);
        if (values.size() > 500) {
          throw new IllegalStateException("TODO fix JBRULES-3371 so this works.");
        }
        for (        Object anchor : values) {
          if (!entityDescriptor.getPlanningEntityClass().isAssignableFrom(anchor.getClass())) {
            List<Object> anchorWithChain=new ArrayList<Object>(values.size());
            anchorWithChain.add(anchor);
            Object trailingEntity=scoreDirector.getTrailingEntity(variableDescriptor,anchor);
            while (trailingEntity != null) {
              anchorWithChain.add(trailingEntity);
              trailingEntity=scoreDirector.getTrailingEntity(variableDescriptor,trailingEntity);
            }
            int chainSize=anchorWithChain.size();
            for (int fromIndex=1; fromIndex < chainSize; fromIndex++) {
              Object oldToValue=anchorWithChain.get(fromIndex - 1);
              for (int toIndex=fromIndex + 2; toIndex <= chainSize; toIndex++) {
                List<Object> entitiesSubChain=anchorWithChain.subList(fromIndex,toIndex);
                Object oldTrailingEntity;
                if (toIndex < chainSize) {
                  oldTrailingEntity=anchorWithChain.get(toIndex);
                }
 else {
                  oldTrailingEntity=null;
                }
                for (                Object toValue : values) {
                  if (!entitiesSubChain.contains(toValue)) {
                    Object newTrailingEntity=scoreDirector.getTrailingEntity(variableDescriptor,toValue);
                    if (!oldToValue.equals((toValue))) {
                      moveList.add(new GenericChainedChangePartMove(entitiesSubChain,variableDescriptor,toValue,oldTrailingEntity,newTrailingEntity));
                    }
                    if (chainSize != entitiesSubChain.size()) {
                      moveList.add(new GenericReverseChainedChangePartMove(entitiesSubChain,variableDescriptor,toValue,oldTrailingEntity,newTrailingEntity));
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  }
  return moveList;
}
